# Exercise 4: Analyzing the internal structure of your object

The goal of this exercise is to:
<ul>
  <li>Learn how to reorient the volume stack of your object</li>
  <li>Crop your volume stack to a specific volume for analysis</li>
  <li>Analyze porosity/inclusions/grain size in a specific region of interest of a ceramic sherd</li>
  <li>Analyze trabecular and cortical bone in a specific region of interest in a bone</li>
</ul>

In this exercise you will focus on analyzing the internal structure of your object. The specific parameters you are interested in analyzing will vary depending on the object of interest. Two common analyses used in archaeology and anthropology are examining the internal structure of a piece of ceramics (perhaps to understand ceramic manufacturing and/or raw material) and examining the internal structure of a human or non-human bone (for example to analyze how force is distributed inside a bone and/or how that bone may have responded to specific loading patterns). You will work through examples of both of these types of analyses here, though in many ways they are very similar. 

### Reorienting your volume stack
When scanning, you are often at the mercy of whatever position will make your object the most stable and as a result your object is often at strange angles relative to the planes of the scan. Reorienting your 3D data with respect to orthogonal planes can therefore be an important step for the types of analyses presented here, because they will require you to crop your data down to a small (often cubic) region of interest that may or may not fit easily in your object depending on its orientation. It is possible to rotate your image stack in FIJI/ImageJ, but we find that it is a bit more straightforward in 3D Slicer. 

First, open the ceramic sherd data in 3D Slicer using the ImageStacks module and make sure you load it at half resolution (see exercise 1 for more details about this step). Now navigate to the Volume Rendering module and make sure that your image stack is visible. Next, use the drop down on the top menu to move to the Transforms module. This module will allow you to change the orientation of your current image stack; in this case you are only interested in making the sherd more “vertical.” Under the Active Transform drop-down menu, select “Create a new Linear Transform.” In the Apply Transform section of the Transform module, make sure that your volume is on the right hand (Transformed) side of the menu. You can switch the sides using the green arrows. Note that in the 3D view options (see Exercise 1) you can toggle the directional indicators of your bounding box on and off. To make the bounding box more closely fit your image stack use the little target icon in the top left of the 3D viewer window. You can also change the direction of the camera by mousing over the pin icon in the top left of the 3D viewer and clicking any one of the letters (“S” being superior, “I” being inferior, etc…).  In the figure below the camera is anterior to the object, hence we can see the “P” (for posterior) at the back of the orientation cube. You will control the position of the object you want to transform from the Translation and rotation menus. You want to rotate the sherd along the antero-posterior axis (PA). We can do this using the sliders in the Transforms module. Under the rotate heading, there are three sliders corresponding to the axes that can be rotated around: LR (left-right), AP (antero-posterior), and SI (supero-inferior). In this case we want to rotate the ceramic sherd about -18 degrees in the PA direction. Then you will want to center the sherd in the bounding box by using the LR and IS sliders in the Translation menu. Feel free to play with the sliders more, but it can get a little slow. One you have the volume in the desired orientation, make sure the volume in the Transformed box is highlighted, and then click the Harden Transform button below the green arrows  (the little button that looks like two Rubik’s cubes).. This should switch your volume back over to the left-hand, “transformable” side, indicating that your object has been transformed, and your volume has been permanently reoriented. You can now segment or crop this volume using other modules. 

Your before/ after orientations will look something like this:
![image](https://user-images.githubusercontent.com/90789390/184920177-07516f9a-3c45-4812-a0d7-089a2002d063.png)

### Cropping your volume to a region of interest (ROI)
There are several ways of cropping a volume. We’ve already covered how to do so in FIJI/ImageJ (see Exercise 1). To crop a volume in 3D Slicer, first navigate to the Crop Volume module. Make sure you have the correct volume selected in the “Input volume” drop down box and that it is visible (you may have to go to the Volume Rendering module to do this). Click the eye button beside “Display ROI” and confirm that the ROI (a white box with colored spheres corresponding to it’s long axes) is now visible on your object and that the ROI corresponds to the long axes of the sherd. You can then use the spheres on each face of the ROI to slide and change its dimensions. Now let’s make a crop of just a small section of the shard, and we will pay attention to the spacing and dimensions, with the goal of cropping to approximately a 5mm<sup>3</sup> volume. Dimensions of your volume are listed in the Volume Information drop down menu. Our spacing, as seen in the Figure below, is .11mm for every dimension - that is essentially our voxel size. You’ll note that the dimensions in voxels will shift as you manipulate the ROI boxes to the left. Let’s say we wanted to make our ROI a cube with 5mm sides, what should the dimensions be if our voxels are 0.11mm? (the answer: around 45, as 5/0.11 =~45). Once you’ve manipulated the ROI to be the dimensions you desire, make sure that “Create new volume” is your output and hit Apply. If you check the Data module, you’ll find a new volume with the “Cropped” suffix. Now save your files, making sure that your cropped nrrd file is saved. You can also view your new cropped volume by going to the Volume Rendering module and turning off the overall sherd and making sure the cropped volume is visible. 

![image](https://user-images.githubusercontent.com/90789390/184920270-cf746f92-09b9-43e2-8863-3aa29845dc85.png)

You can also view your new cropped volume by going to the Volume Rendering module and turning off the overall sherd and making sure the cropped volume is visible. 
![image](https://user-images.githubusercontent.com/90789390/184920324-b82ffdd5-20c2-4537-947e-08903e578a83.png)

### Sherd porosity and density
What if you found a potsherd and wanted to know something about the density of the pottery and what kind of materials made it up? Let’s open up the cropped volume of the tiny bit of shard in FIJI/ImageJ; do this by going to *File>Open…* and then navigating to where your cropped nrrd file (saved from 3D Slicer) is located. This will probably be something like “shard copy cropped_1” depending on what you named it when you saved your 3D Slicer files. In order to run a particle analysis, first we have to make a thresholded image that only features the particles you are interested in. This can be accomplished in ImageJ via *Image>Adjust>Threshold* (these steps are also provided in Exercise 1). If you wish to apply this threshold to the entire image stack, in the first options box select “Stack histogram” and “Dark background”. Click “Auto” or use the sliders until the background is completely red and your material of interest is still visible. Make sure to scroll through the slides to confirm that all of the images have segmented properly; note that if the quality of the scan is not great, the Auto function may not work. Once you are satisfied that you have adequately separated the material of interest from all other materials, click “Apply”. Then in the second options box Deselect “Calculate threshold for each image” (no boxes should be checked). Click “OK”. The resulting image stack should show your material of interest in black and all other pixels in white. You should also make sure that your scale is properly set before running any analyses; check/set your scale by going to *Image>Properties…* (refer to Exercise 1 for more detailed information). 

Now you can run a particle analysis. Do this by selecting *Plugins>BoneJ>Analysis>Particle Analyzer*. This will bring up a Setup box with many options and boxes to check. A description of all of these is beyond the scope of this tutorial, but for details see the [BoneJ website](https://imagej.net/plugins/bonej#particle-analyser). Depending on the size of your images, running the analysis could take a while. If you are unable to segment out some small particles, you can always set the Min Volume to exclude them and thus speed the analysis up. The output will include many metrics (see the above website for a complete list), but probably the most immediately interesting are surface area and volume. Perhaps you are wondering if lighter colored (i.e., denser) particles are significantly larger or smaller than darker colored (i.e., less dense) particles? You could use the thresholding tool to run a particle analysis on batches of particles with different grayscale values and statistically compare the results. 

### Internal analysis of bone
Another type of analysis you may wish to perform is to look at the internal structure of human or non-human bone. These types of analyses have been used to understand pathological processes and behavioral patterns (i.e., how bones are stressed during life). 

First, open the femur data in FIJI/ImageJ. You will want to crop your volume to just a small section of trabecular bone; where you place this region of interest (ROI) will depend on your research question; here we are going to crop to a small (roughly 1 cm<sup>3</sup>) ROI in the medial condyle of the femur (that’s one of those big bumps at the end of the femur). To create a crop that is 1 cm<sup>3</sup> first we must set the scale (*Analyze>Set Scale*). Make sure that the distance in pixels is set to 1 and the known distance is the voxel size, in this case 0.118 mm.  Use the square selection to roughly place your ROI; pay attention to the given height and width of your selection. Since our scale is mm and we want a 1 cm crop, try to get both as close to 10 as possible. Then select *Image>Crop* (you may wish to duplicate your image stack first so you don’t need to reload the data if you are unhappy with the crop). However, remember that this will only crop your data in the X and Y dimensions, not the Z dimension. To crop in the Z dimension use the Delete Slice Range tool by going to *Image>Stacks>Delete Slice Range* (as shown in Exercise 1). Since we want the whole cropped volume to be 1 cm<sup>3</sup>, we’ll want to keep about 85 slices (10 mm divided by 0.118 equals ~85). Threshold the image the same way you did the potsherd; you will want the empty space to be white and the trabecular bone to be black. 

Your thresholded image should look something like this:
![image](https://user-images.githubusercontent.com/90789390/184920515-fbd8451b-1b57-4754-85a3-c72b86538101.png)

Once you have a thresholded image, there are a few things you might be interested in. For example, bone is a living tissue that in certain situations will remodel itself to more effectively manage stress and strain. Because bone is stronger under compression, trabeculae should be oriented along the principal axes of the strains in the bone. BoneJ can mathematically calculate if the trabecular struts are oriented in more or less the same direction (i.e., anisotropic), or if they are more randomly distributed (i.e., isotropic). You can calculate this measure by navigating to *Plugins>BoneJ>Anisotropy*. This analysis will give you a single output metric: DA (degree of anisotropy) for your entire volume. A value closer to 1 means that the trabeculae in the volume are anisotropic; in other words they are highly organized in a particular direction. A value closer to 0 means the trabeculae are more isotropic; in other words, there is no particular direction to the trabecular orientation. This may or may not be in the direction that you would predict given the strains this bone was subjected to. 

We can also calculate the ratio of bone volume (BV) to the total volume of your sample (TV); this measure is known as BV/TV. To calculate this measure, navigate to *Plugins>BoneJ>Fraction>Area/Volume Fraction*. The output here is also a single metric - the ratio of bone to non-bone (i.e., air) in your image stack. A zero will mean there is no bone, while a 1 will mean your stack is entirely bone. 

ImageJ is also helpful when it comes to cross-sectional properties of long bones. The Slice Geometry tool (*Plugins>BoneJ>Slice Geometry*) can give us information such as 2nd moments of area and the location of the minor and major axes through a particular cross-section of bone. Here we would load just a single slice from our femur, preferably one from the diaphysis (shaft). One of the nice things about the Slice Geometry tool is that we don’t have to pre-threshold; we can simply tell the tool which grayscale values are worth looking into. The output will graphically show the major and minor axes of the cortical bone slice and will give us many metrics, such as the total cross-sectional area of the bone (in mm<sup>2</sup>). Of course it will be necessary to scale the image in order for your metrics to make real sense (see Exercise 1). Probably the most relevant output metric here will be the second moments of area - here labeled Imin (mm<sup>4</sup>) and Imax(mm<sup>4</sup>). The Imin will be the moment around the major axis, while Imax will be the moment around the minor axis (confusing but true, sorry). This will give you a rough estimation of how material is distributed - if the two numbers are roughly equal, this means you have a roughly circular cross-section. The degree to which the Imin is greater (and it always will be) will tell you how “stretched out” the bone is across that axis. For example, the cross-section on the left in the image below is much more circular and has moments of area that are close in magnitude. The cross-section on the right is clearly longer in one direction and as such its Imin is close to twice that of its Imax. 

![image](https://user-images.githubusercontent.com/90789390/184920596-009aa1b1-b257-4e75-b1a5-0d5dd6c863be.png)

## Next Up
### [Conclusion](/conclusion.md)
